<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>学習ログ | JP & Dev Study Log</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>

    <!-- Babel (no-build JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body class="bg-white text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const STORAGE_KEY = "jp-dev-study-log__entries_v1";

      function loadEntries() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function saveEntries(entries) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      }

      function uid() {
        return Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      function App() {
        const [entries, setEntries] = useState(() => loadEntries());
        const [category, setCategory] = useState("日本語");
        const [title, setTitle] = useState("");
        const [content, setContent] = useState("");

        const [filter, setFilter] = useState("ALL"); // ALL | JP | DEV
        const [q, setQ] = useState("");

        const [editingId, setEditingId] = useState(null);

        const titleRef = useRef(null);

        useEffect(() => {
          saveEntries(entries);
        }, [entries]);

        const filtered = useMemo(() => {
          const lower = q.trim().toLowerCase();

          return entries
            .filter((e) => {
              if (filter === "JP") return e.category === "日本語";
              if (filter === "DEV") return e.category === "コーディング";
              return true;
            })
            .filter((e) => {
              if (!lower) return true;
              return (
                (e.title || "").toLowerCase().includes(lower) ||
                (e.content || "").toLowerCase().includes(lower)
              );
            })
            .sort(
              (a, b) =>
                (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt)
            );
        }, [entries, filter, q]);

        function resetForm() {
          setCategory("日本語");
          setTitle("");
          setContent("");
          setEditingId(null);
        }

        function onSubmit(e) {
          e.preventDefault();
          const t = title.trim();
          const c = content.trim();
          if (!t || !c) return;

          const now = Date.now();

          if (editingId) {
            setEntries((prev) =>
              prev.map((it) =>
                it.id === editingId
                  ? { ...it, category, title: t, content: c, updatedAt: now }
                  : it
              )
            );
          } else {
            setEntries((prev) => [
              ...prev,
              {
                id: uid(),
                category,
                title: t,
                content: c,
                createdAt: now,
                updatedAt: now,
              },
            ]);
          }

          resetForm();
          setTimeout(() => titleRef.current?.focus(), 0);
        }

        function onEdit(item) {
          setEditingId(item.id);
          setCategory(item.category);
          setTitle(item.title);
          setContent(item.content);
          setTimeout(() => titleRef.current?.focus(), 0);
        }

        function onDelete(id) {
          setEntries((prev) => prev.filter((it) => it.id !== id));
          if (editingId === id) resetForm();
        }

        return (
          <div className="mx-auto max-w-3xl px-5 py-10">
            <header className="mb-8">
              <h1 className="text-3xl font-bold tracking-tight">
                JP &amp; Dev Study Log
              </h1>
              <nav className="mt-3 flex gap-4 text-sm">
                <a className="underline underline-offset-4" href="./index.html">
                  ホーム
                </a>
                <a className="underline underline-offset-4" href="./study.html">
                  学習ログ
                </a>
              </nav>
            </header>

            <main className="space-y-10">
              <section className="space-y-3">
                <h2 className="text-xl font-semibold">学習ログ</h2>
                <p className="leading-7 text-slate-700">
                  日本語とコーディングの学習記録をまとめています。入力した内容はブラウザの
                  <code className="mx-1 rounded bg-slate-100 px-1 py-0.5 text-[0.95em]">
                    localStorage
                  </code>
                  に保存されます。
                </p>
                <p className="leading-7 text-slate-700">
                  基本的な CRUD（追加・閲覧・編集・削除） と
                  フィルター・検索機能をすべて実装しています。
                </p>
              </section>

              <section className="space-y-4">
                <h3 className="text-lg font-semibold">新しいログを追加</h3>

                <form
                  onSubmit={onSubmit}
                  className="space-y-4 rounded-xl border border-slate-200 p-4"
                >
                  <div className="grid gap-3 sm:grid-cols-2">
                    <label className="block">
                      <div className="mb-1 text-sm font-medium text-slate-700">
                        カテゴリ
                      </div>
                      <select
                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm"
                        value={category}
                        onChange={(e) => setCategory(e.target.value)}
                      >
                        <option value="日本語">日本語</option>
                        <option value="コーディング">コーディング</option>
                      </select>
                    </label>

                    <label className="block">
                      <div className="mb-1 text-sm font-medium text-slate-700">
                        タイトル
                      </div>
                      <input
                        ref={titleRef}
                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm"
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        placeholder="例）N2 文法：〜わけではない"
                      />
                    </label>
                  </div>

                  <label className="block">
                    <div className="mb-1 text-sm font-medium text-slate-700">
                      内容
                    </div>
                    <textarea
                      className="min-h-[120px] w-full rounded-lg border border-slate-300 px-3 py-2 text-sm leading-6"
                      value={content}
                      onChange={(e) => setContent(e.target.value)}
                      placeholder="学んだこと、エラー原因、気づき、例文など"
                    />
                  </label>

                  <div className="flex flex-wrap gap-2">
                    <button
                      type="submit"
                      className="rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium hover:bg-slate-50"
                    >
                      {editingId ? "更新する" : "保存する"}
                    </button>

                    {editingId && (
                      <button
                        type="button"
                        onClick={resetForm}
                        className="rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium hover:bg-slate-50"
                      >
                        キャンセル
                      </button>
                    )}
                  </div>
                </form>
              </section>

              <section className="space-y-4">
                <h3 className="text-lg font-semibold">ログ一覧</h3>

                <div className="flex flex-col gap-3 rounded-xl border border-slate-200 p-4 sm:flex-row sm:items-end">
                  <label className="block sm:w-56">
                    <div className="mb-1 text-sm font-medium text-slate-700">
                      フィルター
                    </div>
                    <select
                      className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm"
                      value={filter}
                      onChange={(e) => setFilter(e.target.value)}
                    >
                      <option value="ALL">すべて</option>
                      <option value="JP">日本語だけ</option>
                      <option value="DEV">コーディングだけ</option>
                    </select>
                  </label>

                  <label className="block flex-1">
                    <div className="mb-1 text-sm font-medium text-slate-700">
                      検索
                    </div>
                    <input
                      className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm"
                      value={q}
                      onChange={(e) => setQ(e.target.value)}
                      placeholder="タイトル / 内容で検索"
                    />
                  </label>
                </div>

                {filtered.length === 0 ? (
                  <p className="text-sm text-slate-600">
                    まだログがありません。
                  </p>
                ) : (
                  <ul className="space-y-3">
                    {filtered.map((it) => (
                      <li
                        key={it.id}
                        className="rounded-xl border border-slate-200 p-4"
                      >
                        <div className="flex flex-wrap items-start justify-between gap-2">
                          <div>
                            <div className="text-xs font-semibold text-slate-500">
                              {it.category}
                            </div>
                            <div className="mt-1 text-base font-semibold">
                              {it.title}
                            </div>
                          </div>

                          <div className="flex gap-2">
                            <button
                              className="rounded-lg border border-slate-300 px-3 py-1.5 text-xs font-medium hover:bg-slate-50"
                              onClick={() => onEdit(it)}
                              type="button"
                            >
                              編集
                            </button>
                            <button
                              className="rounded-lg border border-slate-300 px-3 py-1.5 text-xs font-medium hover:bg-slate-50"
                              onClick={() => onDelete(it.id)}
                              type="button"
                            >
                              削除
                            </button>
                          </div>
                        </div>

                        <p className="mt-3 whitespace-pre-wrap text-sm leading-7 text-slate-700">
                          {it.content}
                        </p>

                        <div className="mt-3 text-xs text-slate-500">
                          更新：
                          {new Date(
                            it.updatedAt || it.createdAt
                          ).toLocaleString()}
                        </div>
                      </li>
                    ))}
                  </ul>
                )}
              </section>
            </main>

            <footer className="mt-12 border-t pt-6 text-sm text-slate-500">
              © 2025 JP &amp; Dev Study Log
            </footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
